# Trigger the pipeline on changes to the main branch only within the backend/src/PMS.Api directory
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - backend/src/**

variables:
  appRoot: backend/src/PMS.Api/PMS.Api.csproj
  buildDir: $(Build.ArtifactStagingDirectory)

pool:
  name: Default

steps:
- task: UseDotNet@2
  inputs:
    packageType: sdk
    version: '10.0.x'
  displayName: 'Install .NET 10.x SDK'

- task: DotNetCoreCLI@2
  inputs:
    command: restore
    projects: '$(appRoot)'
  displayName: 'Install Dependencies'

- task: DotNetCoreCLI@2
  inputs:
    command: build
    projects: '$(appRoot)'
    arguments: '--configuration Release --no-restore'
  displayName: 'Build Project'


- task: DotNetCoreCLI@2
  inputs:
    command: custom
    custom: 'tool'
    arguments: 'install --global dotnet-ef'
  displayName: 'Install EF Tool'

- task: DotNetCoreCLI@2
  inputs:
    command: custom
    custom: 'ef '
    arguments: migrations bundle --self-contained --project "$(appRoot)" --startup-project "$(appRoot)" -r win-x64 -o "$(Build.ArtifactStagingDirectory)/SQL/Bundle.exe" --verbose
  displayName: 'Create EF Migrations Bundle'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/SQL'
    ArtifactName: 'SQL'
    publishLocation: 'Container'
  displayName: 'Publish SQL Bundle Artifact'

- pwsh: |
    $bundle = "$(Build.ArtifactStagingDirectory)\SQL\Bundle.exe"
    $conn   = "$(ConnectionString)"

    $max = 10
    for ($i = 1; $i -le $max; $i++) {
      Write-Host "Attempt $i/$max: running EF migrations bundle..."
      & $bundle --connection $conn

      if ($LASTEXITCODE -eq 0) {
        Write-Host "Success."
        exit 0
      }

      Write-Host "Failed with exit code $LASTEXITCODE. Waiting then retrying..."
      Start-Sleep -Seconds (8 * $i)
    }

    throw "Bundle failed after $max attempts."
  displayName: 'Apply EF Migrations to PROD (retry)'

  
- pwsh: |
    Remove-Item "$(buildDir)\publish" -Recurse -Force -ErrorAction SilentlyContinue
    New-Item -ItemType Directory -Path "$(buildDir)\publish" -Force | Out-Null
  displayName: 'Prepare publish folder'

- task: DotNetCoreCLI@2
  inputs:
    command: publish
    projects: '$(appRoot)'
    publishWebProjects: false
    arguments: '--configuration Release --output "$(buildDir)/publish" --no-build --no-restore'
    zipAfterPublish: true
  displayName: 'Publish Project'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(buildDir)/publish'
    ArtifactName: 'PMSApiArtifact'
    publishLocation: 'Container'
  displayName: 'Publish Artifact to Azure Pipelines'

- task: AzureWebApp@1
  inputs:
    azureSubscription: 'service-connection'
    appType: webApp
    appName: 'api-pms'
    package: '$(buildDir)/publish/**/*.zip'
  displayName: 'Deploy to Azure Web App'